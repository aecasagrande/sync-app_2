<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Sync App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .log-container::-webkit-scrollbar, #trialList::-webkit-scrollbar { width: 8px; }
        .log-container::-webkit-scrollbar-track, #trialList::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .log-container::-webkit-scrollbar-thumb, #trialList::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        .trial-item.selected { background-color: #3b82f6; color: white; font-weight: 500; }
        .sortable-ghost { background-color: #dbeafe; opacity: 0.7; }
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        
        /* New Timer Style */
        .timer-active { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        .timer-text { font-family: 'Monaco', 'Consolas', monospace; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-3xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Time Sync App</h1>
        <p id="realTimeClock" class="text-xl font-medium text-center text-gray-600 mb-6 font-mono"></p>
        <div class="mb-6">
            <div class="flex justify-between items-end mb-2">
                <label class="block text-sm font-medium text-gray-700">1. Select Trial</label>
                <div class="flex items-center">
                    <span class="mr-2 text-xs font-medium text-gray-500 uppercase tracking-wider">Lock</span>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="editModeToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300"/>
                        <label for="editModeToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                    <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Edit</span>
                </div>
            </div>
            <div id="activeSelectionDisplay" class="w-full p-4 mb-2 bg-blue-50 border-2 border-blue-200 rounded-lg text-center shadow-sm transition-all duration-300">
                <span id="selectionHeader" class="text-gray-500 text-xs uppercase font-bold block mb-1">Currently Selected</span>
                <span id="activeSelectionText" class="text-lg font-bold text-blue-800">None</span>
                <div id="countdownDisplay" class="hidden text-3xl font-black text-red-600 timer-text mt-1">00:00</div>
            </div>
            <ul id="trialList" class="w-full max-h-48 overflow-y-auto border border-gray-300 rounded-lg bg-white shadow-sm"></ul>
            
            <div class="mt-4">
                <label for="notesInput" class="block text-sm font-medium text-gray-700 mb-2">2. Add Notes (Optional)</label>
                <textarea id="notesInput" rows="2" placeholder="Enter notes..." class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"></textarea>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-3 mt-4">
                <input type="text" id="customTagInput" placeholder="Type new tag (e.g. Test_5min)..." class="flex-grow block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex gap-3 mt-3">
                <button id="addTagButton" class="w-full px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-200 disabled:opacity-50">Add Tag</button>
                <button id="removeTagButton" class="w-full px-5 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-200 disabled:opacity-50">Remove Selected</button>
            </div>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
            <button id="startButton" class="w-full py-4 px-6 bg-green-500 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-green-600 transition duration-200 disabled:opacity-50">START</button>
            <button id="stopButton" class="w-full py-4 px-6 bg-red-500 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-red-600 transition duration-200 disabled:opacity-50">STOP</button>
        </div>
        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
            <h2 class="text-2xl font-semibold text-gray-700">Event Log</h2>
            <div class="flex gap-2 flex-wrap">
                <button id="discardLastButton" class="px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded-lg shadow-md hover:bg-yellow-600 disabled:opacity-50">Discard Last Trial</button>
                <button id="resetLogButton" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg shadow-md hover:bg-red-700 disabled:opacity-50">Reset Log</button>
                <button id="exportButton" class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg shadow-md hover:bg-gray-700 disabled:opacity-50">Export CSV</button>
            </div>
        </div>
        <div class="log-container w-full max-h-80 overflow-y-auto border border-gray-200 rounded-lg bg-gray-50 p-1">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100 sticky top-0">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trial</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Event</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                    </tr>
                </thead>
                <tbody id="logBody" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
        <p id="emptyLogMessage" class="text-center text-gray-500 pt-4">Log is empty.</p>
    </div>
    
    <!-- Discard Last Trial Confirmation Modal -->
    <div id="discardModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-200">
        <div id="discardModalContent" class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 transform scale-95 transition-transform duration-200">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Discard Last Trial?</h3>
            <p class="text-gray-600 mb-2">This will remove the most recent trial's Start and Stop entries:</p>
            <p id="discardTrialName" class="text-lg font-semibold text-blue-600 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="cancelDiscardButton" class="px-5 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmDiscardButton" class="px-5 py-2 bg-yellow-600 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-700">Discard</button>
            </div>
        </div>
    </div>
    
    <!-- Reset Log Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-200">
        <div id="modalContent" class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 transform scale-95 transition-transform duration-200">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Are you sure?</h3>
            <p class="text-gray-600 mb-6">This will permanently delete all log entries.</p>
            <div class="flex justify-end gap-3">
                <button id="cancelResetButton" class="px-5 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="confirmResetButton" class="px-5 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE ---
            let logData = [];
            let isTiming = false;
            let currentTrialName = '';
            let selectedTrialElement = null; 
            let sortableInstance = null;
            let timerInterval = null;
            let remainingSeconds = 0;
            let trialNames = [
                'OFF_5min_Sitting', 'OFF_5min_Standing', 'OFF_5min_Walking', 'OFF_Giladi_Walk',
                'OFF_Giladi_DTWalk', 'OFF_Giladi_Carrying', 'OFF_Giladi_Turns', 'OFF_Giladi_DTTurns',
                'OFF_Giladi_Shuffle', 'OFF_Giladi_Agility', 'OFF_Giladi_Doorway', 'OFF_2min_VR_Sitting',
                'OFF_2min_VR_Standing', 'OFF_2min_VR_Walking', 'OFF_30s_T1', 'OFF_Trial1', 'OFF_30s_T2',
                'OFF_Trial2', 'OFF_30s_T3', 'OFF_Trial3', 'OFF_30s_T4', 'OFF_Trial4', 'OFF_30s_T5',
                'OFF_Trial5', 'OFF_30s_T6', 'OFF_Trial6', 'OFF_30s_T7', 'OFF_Trial7', 'OFF_30s_T8',
                'OFF_Trial8', 'OFF_30s_T9', 'OFF_Trial9', 'OFF_30s_T10', 'OFF_Trial10',
                'ON_5min_Sitting', 'ON_5min_Standing', 'ON_5min_Walking', 'ON_Giladi_Walk',
                'ON_Giladi_DTWalk', 'ON_Giladi_Carrying', 'ON_Giladi_Turns', 'ON_Giladi_DTTurns',
                'ON_Giladi_Shuffle', 'ON_Giladi_Agility', 'ON_Giladi_Doorway', 'ON_2min_VR_Sitting',
                'ON_2min_VR_Standing', 'ON_2min_VR_Walking', 'ON_30s_T1', 'ON_Trial1', 'ON_30s_T2',
                'ON_Trial2', 'ON_30s_T3', 'ON_Trial3', 'ON_30s_T4', 'ON_Trial4', 'ON_30s_T5',
                'ON_Trial5', 'ON_30s_T6', 'ON_Trial6', 'ON_30s_T7', 'ON_Trial7', 'ON_30s_T8',
                'ON_Trial8', 'ON_30s_T9', 'ON_Trial9', 'ON_30s_T10', 'ON_Trial10'
            ];
            
            // --- DOM ELEMENTS ---
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const exportButton = document.getElementById('exportButton');
            const trialList = document.getElementById('trialList');
            const notesInput = document.getElementById('notesInput');
            const customTagInput = document.getElementById('customTagInput');
            const addTagButton = document.getElementById('addTagButton');
            const removeTagButton = document.getElementById('removeTagButton');
            const discardLastButton = document.getElementById('discardLastButton');
            const resetLogButton = document.getElementById('resetLogButton');
            const logBody = document.getElementById('logBody');
            const emptyLogMessage = document.getElementById('emptyLogMessage');
            const clockElement = document.getElementById('realTimeClock');
            const activeSelectionText = document.getElementById('activeSelectionText');
            const countdownDisplay = document.getElementById('countdownDisplay');
            const activeSelectionDisplay = document.getElementById('activeSelectionDisplay');
            const selectionHeader = document.getElementById('selectionHeader');
            const editModeToggle = document.getElementById('editModeToggle');
            const confirmationModal = document.getElementById('confirmationModal');
            const modalContent = document.getElementById('modalContent');
            const cancelResetButton = document.getElementById('cancelResetButton');
            const confirmResetButton = document.getElementById('confirmResetButton');
            
            // Discard modal elements
            const discardModal = document.getElementById('discardModal');
            const discardModalContent = document.getElementById('discardModalContent');
            const discardTrialName = document.getElementById('discardTrialName');
            const cancelDiscardButton = document.getElementById('cancelDiscardButton');
            const confirmDiscardButton = document.getElementById('confirmDiscardButton');
            
            // --- AUDIO BEEP FUNCTION ---
            function playBeep() {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 1);
                oscillator.stop(audioCtx.currentTime + 1);
            }
            
            // --- HELPER FUNCTIONS ---
            function getTrialDuration(name) {
                if (name.includes('5min')) return 300;
                if (name.includes('2min')) return 120;
                if (name.includes('30s')) return 30;
                return 0;
            }
            
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
            
            function updateClock() {
                const parts = new Date().toString().split(' ');
                clockElement.textContent = parts[4] + ' ' + parts.slice(5).join(' ');
            }
            
            function handleTrialClick(e) {
                if (isTiming) return;
                const clickedItem = e.currentTarget;
                if (selectedTrialElement) selectedTrialElement.classList.remove('selected');
                clickedItem.classList.add('selected');
                selectedTrialElement = clickedItem;
                activeSelectionText.textContent = clickedItem.textContent;
                updateButtonStates();
            }
            
            function handleStart() {
                if (!selectedTrialElement) return;
                isTiming = true;
                currentTrialName = selectedTrialElement.textContent;
                
                logData.push({ 
                    trial: currentTrialName, 
                    event: 'Start', 
                    notes: notesInput.value.trim(), 
                    timestamp: new Date().toString() 
                });
                notesInput.value = '';
                renderLog();
                
                remainingSeconds = getTrialDuration(currentTrialName);
                if (remainingSeconds > 0) {
                    startCountdown();
                }
                
                updateButtonStates();
            }
            
            function startCountdown() {
                activeSelectionDisplay.classList.add('timer-active');
                selectionHeader.textContent = "Time Remaining";
                countdownDisplay.classList.remove('hidden');
                countdownDisplay.textContent = formatTime(remainingSeconds);
                timerInterval = setInterval(() => {
                    remainingSeconds--;
                    countdownDisplay.textContent = formatTime(remainingSeconds);
                    if (remainingSeconds <= 0) {
                        clearInterval(timerInterval);
                        playBeep();
                        handleStop();
                    }
                }, 1000);
            }
            
            function handleStop() {
                clearInterval(timerInterval);
                isTiming = false;
                
                activeSelectionDisplay.classList.remove('timer-active');
                selectionHeader.textContent = "Currently Selected";
                countdownDisplay.classList.add('hidden');
                logData.push({ 
                    trial: currentTrialName, 
                    event: 'Stop', 
                    notes: '', 
                    timestamp: new Date().toString() 
                });
                renderLog();
                
                if (selectedTrialElement) {
                    const allItems = Array.from(trialList.querySelectorAll('li.trial-item'));
                    const currentIndex = allItems.indexOf(selectedTrialElement);
                    if (currentIndex < allItems.length - 1) {
                        const nextItem = allItems[currentIndex + 1];
                        nextItem.click();
                        nextItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }
                updateButtonStates();
            }
            
            function getLastCompletedTrial() {
                // Find the last Stop event
                for (let i = logData.length - 1; i >= 0; i--) {
                    if (logData[i].event === 'Stop') {
                        return logData[i].trial;
                    }
                }
                return null;
            }
            
            function handleDiscardLast() {
                const lastTrial = getLastCompletedTrial();
                if (!lastTrial) return;
                
                discardTrialName.textContent = lastTrial;
                discardModal.classList.remove('hidden');
                setTimeout(() => { 
                    discardModal.classList.remove('opacity-0'); 
                    discardModalContent.classList.remove('scale-95'); 
                }, 10);
            }
            
            function confirmDiscardTrial() {
                const lastTrial = getLastCompletedTrial();
                if (!lastTrial) return;
                
                // Remove all entries for the last completed trial (both Start and Stop)
                logData = logData.filter(entry => {
                    // Keep entries that are NOT from the last trial
                    if (entry.trial !== lastTrial) return true;
                    
                    // For the last trial, find the last pair and remove them
                    const lastStartIndex = logData.map((e, i) => e.trial === lastTrial && e.event === 'Start' ? i : -1).filter(i => i !== -1).pop();
                    const lastStopIndex = logData.map((e, i) => e.trial === lastTrial && e.event === 'Stop' ? i : -1).filter(i => i !== -1).pop();
                    
                    const currentIndex = logData.indexOf(entry);
                    return currentIndex !== lastStartIndex && currentIndex !== lastStopIndex;
                });
                
                // Simpler approach: just remove the last two entries if they form a Start-Stop pair
                if (logData.length >= 2) {
                    const lastEntry = logData[logData.length - 1];
                    const secondLastEntry = logData[logData.length - 2];
                    
                    if (lastEntry.event === 'Stop' && 
                        secondLastEntry.event === 'Start' && 
                        lastEntry.trial === secondLastEntry.trial) {
                        logData.splice(-2, 2);
                    }
                }
                
                renderLog();
                cancelDiscardButton.click();
            }
            
            // --- CORE FUNCTIONALITY ---
            function createTrialItem(name) {
                const li = document.createElement('li');
                li.className = 'trial-item p-3 hover:bg-gray-100 cursor-pointer border-b last:border-b-0 select-none';
                li.textContent = name;
                li.addEventListener('click', handleTrialClick);
                return li;
            }
            
            function populateTrialList() {
                trialList.innerHTML = '';
                trialNames.forEach(name => trialList.appendChild(createTrialItem(name)));
                if (trialList.firstChild) trialList.firstChild.click();
                updateButtonStates();
            }
            
            function renderLog() {
                logBody.innerHTML = ''; 
                emptyLogMessage.classList.toggle('hidden', logData.length > 0);
                exportButton.disabled = logData.length === 0;
                
                logData.forEach(entry => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${entry.trial}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${entry.event === 'Start' ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold'}">${entry.event}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${entry.notes || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${entry.timestamp}</td>
                    `;
                    logBody.appendChild(row);
                });
                
                updateButtonStates();
            }
            
            function updateButtonStates() {
                startButton.disabled = isTiming;
                stopButton.disabled = !isTiming;
                trialList.classList.toggle('opacity-50', isTiming);
                trialList.classList.toggle('pointer-events-none', isTiming);
                notesInput.disabled = isTiming;
                editModeToggle.disabled = isTiming;
                
                // Discard button should be enabled only if there's a completed trial (with Stop event)
                const hasCompletedTrial = logData.some(entry => entry.event === 'Stop');
                discardLastButton.disabled = !hasCompletedTrial || isTiming;
            }
            
            // --- INITIALIZATION ---
            setInterval(updateClock, 1000);
            updateClock();
            populateTrialList();
            sortableInstance = new Sortable(trialList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                disabled: true,
                onEnd: () => {
                    trialNames = Array.from(trialList.querySelectorAll('li')).map(li => li.textContent);
                }
            });
            
            // --- EVENT LISTENERS ---
            startButton.addEventListener('click', handleStart);
            stopButton.addEventListener('click', handleStop);
            
            addTagButton.addEventListener('click', () => {
                const val = customTagInput.value.trim();
                if (val && !trialNames.includes(val)) {
                    trialNames.push(val);
                    const li = createTrialItem(val);
                    trialList.appendChild(li);
                    li.click();
                    customTagInput.value = '';
                }
            });
            
            removeTagButton.addEventListener('click', () => {
                if (selectedTrialElement) {
                    trialNames = trialNames.filter(n => n !== selectedTrialElement.textContent);
                    selectedTrialElement.remove();
                    if (trialList.firstChild) trialList.firstChild.click();
                }
            });
            
            editModeToggle.addEventListener('change', (e) => {
                sortableInstance.option('disabled', !e.target.checked);
                trialList.classList.toggle('bg-yellow-50', e.target.checked);
            });
            
            // Discard Last Trial handlers
            discardLastButton.addEventListener('click', handleDiscardLast);
            cancelDiscardButton.addEventListener('click', () => {
                discardModal.classList.add('opacity-0');
                discardModalContent.classList.add('scale-95');
                setTimeout(() => discardModal.classList.add('hidden'), 200);
            });
            confirmDiscardButton.addEventListener('click', confirmDiscardTrial);
            
            // Reset Log handlers
            resetLogButton.addEventListener('click', () => {
                confirmationModal.classList.remove('hidden');
                setTimeout(() => { 
                    confirmationModal.classList.remove('opacity-0'); 
                    modalContent.classList.remove('scale-95'); 
                }, 10);
            });
            
            cancelResetButton.addEventListener('click', () => {
                confirmationModal.classList.add('opacity-0');
                modalContent.classList.add('scale-95');
                setTimeout(() => confirmationModal.classList.add('hidden'), 200);
            });
            
            confirmResetButton.addEventListener('click', () => {
                logData = [];
                renderLog();
                handleStop();
                cancelResetButton.click();
            });
            
            exportButton.addEventListener('click', () => {
                let csv = "Trial,Event,Notes,Timestamp\n" + logData.map(e => `${e.trial},${e.event},"${e.notes}","${e.timestamp}"`).join("\n");
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('href', url);
                a.setAttribute('download', 'log.csv');
                a.click();
            });
        });
    </script>
</body>
</html>
