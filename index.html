<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Sync App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Load Sortable.js for Drag-and-Drop -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* Apply the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for the log */
        .log-container::-webkit-scrollbar,
        #trialList::-webkit-scrollbar {
            width: 8px;
        }
        .log-container::-webkit-scrollbar-track,
        #trialList::-webkit-scrollbar-track {
            background: #f1f5f9; /* gray-100 */
            border-radius: 10px;
        }
        .log-container::-webkit-scrollbar-thumb,
        #trialList::-webkit-scrollbar-thumb {
            background: #94a3b8; /* gray-400 */
            border-radius: 10px;
        }
        .log-container::-webkit-scrollbar-thumb:hover,
        #trialList::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* gray-500 */
        }
        
        /* Styles for the confirmation modal */
        #confirmationModal {
            transition: opacity 0.2s ease-in-out;
        }
        #modalContent {
            transition: transform 0.2s ease-in-out;
        }
        
        /* Styles for new sortable list */
        .trial-item {
            transition: background-color 0.1s ease-in-out;
        }
        
        /* Style for the selected trial */
        .trial-item.selected {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 500;
        }
        
        /* Style for the item being dragged (Sortable.js class) */
        .sortable-ghost {
            background-color: #dbeafe; /* blue-100 */
            opacity: 0.7;
            border-radius: 0.5rem; /* rounded-lg */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-3xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
            Time Sync App
        </h1>

        <!-- Real-time Clock -->
        <p id="realTimeClock" class="text-xl font-medium text-center text-gray-600 mb-6 font-mono">
            <!-- Clock will be populated by JS -->
        </p>

        <!-- Trial Selection and Custom Tag Input -->
        <div class="mb-6">
            <label for="trialList" class="block text-sm font-medium text-gray-700 mb-2">
                1. Select Trial (Click to select, Drag to re-order)
            </label>
            <!-- Sortable List (replaces dropdown) -->
            <ul id="trialList" class="w-full max-h-48 overflow-y-auto border border-gray-300 rounded-lg bg-white shadow-sm disabled:opacity-50 disabled:bg-gray-50">
                <!-- Trial items will be populated by JS -->
            </ul>
            
            <!-- Notes Input -->
            <div class="mt-3">
                <label for="notesInput" class="block text-sm font-medium text-gray-700 mb-2">
                    2. Add Notes (Optional)
                </label>
                <textarea id="notesInput" rows="3" placeholder="Enter notes for this trial..." class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50 disabled:bg-gray-50"></textarea>
            </div>
            
            <!-- Add/Remove Tag -->
            <div class="flex flex-col sm:flex-row gap-3 mt-4">
                <input type="text" id="customTagInput" placeholder="Type new tag name..." class="flex-grow block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50 disabled:bg-gray-50">
            </div>
            <div class="flex gap-3 mt-3">
                <button id="addTagButton" class="w-full px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 disabled:opacity-50">
                    Add Tag
                </button>
                 <button id="removeTagButton" class="w-full px-5 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Remove Selected Tag
                </button>
            </div>
        </div>

        <!-- Start / Stop Buttons -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
            <button id="startButton" class="w-full py-4 px-6 bg-green-500 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                START
            </button>
            <button id="stopButton" class="w-full py-4 px-6 bg-red-500 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                STOP
            </button>
        </div>

        <!-- Log Area -->
        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
            <h2 class="text-2xl font-semibold text-gray-700">
                Event Log
            </h2>
            <div class="flex gap-2 flex-wrap">
                <button id="discardLastButton" class="px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded-lg shadow-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Discard Last
                </button>
                <button id="resetLogButton" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Reset Log
                </button>
                <button id="exportButton" class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Export to CSV
                </button>
            </div>
        </div>

        <div class="log-container w-full max-h-80 overflow-y-auto border border-gray-200 rounded-lg bg-gray-50 p-1">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Trial
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Event
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Notes
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Timestamp
                            </th>
                        </tr>
                    </thead>
                    <tbody id="logBody" class="bg-white divide-y divide-gray-200">
                        <!-- Log entries will be populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
        <p id="emptyLogMessage" class="text-center text-gray-500 pt-4">Log is empty.</p>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div id="modalContent" class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 transform scale-95">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Are you sure?</h3>
            <p class="text-gray-600 mb-6">This action will permanently delete all log entries. This cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button id="cancelResetButton" class="px-5 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200">
                    Cancel
                </button>
                <button id="confirmResetButton" class="px-5 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200">
                    Confirm Reset
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE ---
            let logData = [];
            let isTiming = false;
            let currentTrialName = '';
            let selectedTrialElement = null; // Holds the currently selected <li>
            // Use an Array to maintain order
            let trialNames = [
                'OFF_30s_T1',
                'Trial1',
                'OFF_30s_T2',
                'Trial2',
                'OFF_30s_T3',
                'Trial3',
                'OFF_30s_T4',
                'Trial4',
                'OFF_30s_T5',
                'Trial5',
                'OFF_30s_T6',
                'Trial6',
                'OFF_30s_T7',
                'Trial7',
                'OFF_30s_T8',
                'Trial8',
                'OFF_30s_T9',
                'Trial9',
                'OFF_30s_T10',
                'Trial10',
                'ON_30s_T1',
                'ON_T1',
                'ON_30s_T2',
                'ON_T2',
                'ON_30s_T3',
                'ON_T3',
                'ON_30s_T4',
                'ON_T4',
                'ON_30s_T5',
                'ON_T5',
                'ON_30s_T6',
                'ON_T6',
                'ON_30s_T7',
                'ON_T7',
                'ON_30s_T8',
                'ON_T8',
                'ON_30s_T9',
                'ON_T9',
                'ON_30s_T10',
                'ON_T10',
                'OFF_TRIAL1',
                'OFF_TRIAL2',
                'OFF_TRIAL3',
                'OFF_TRIAL4',
                'OFF_TRIAL5',
                'OFF_TRIAL6',
                'OFF_TRIAL7',
                'OFF_TRIAL8',
                'OFF_TRIAL9',
                'OFF_TRIAL10'
            ];

            // --- DOM ELEMENTS ---
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const exportButton = document.getElementById('exportButton');
            const trialList = document.getElementById('trialList'); // New <ul>
            const notesInput = document.getElementById('notesInput');
            const customTagInput = document.getElementById('customTagInput');
            const addTagButton = document.getElementById('addTagButton');
            const removeTagButton = document.getElementById('removeTagButton');
            // 'Move Up' and 'Move Down' buttons are removed
            const discardLastButton = document.getElementById('discardLastButton');
            const resetLogButton = document.getElementById('resetLogButton');
            const logBody = document.getElementById('logBody');
            const emptyLogMessage = document.getElementById('emptyLogMessage');
            const clockElement = document.getElementById('realTimeClock');
            
            // Modal Elements
            const confirmationModal = document.getElementById('confirmationModal');
            const modalContent = document.getElementById('modalContent');
            const cancelResetButton = document.getElementById('cancelResetButton');
            const confirmResetButton = document.getElementById('confirmResetButton');

            // --- FUNCTIONS ---
            
            /**
             * Updates the real-time clock
             */
            function updateClock() {
                if (clockElement) {
                    const fullString = new Date().toString();
                    const parts = fullString.split(' ');
                    // parts[4] is the time (e.g., 22:01:21)
                    // parts.slice(5) are the timezone parts
                    const clockText = parts[4] + ' ' + parts.slice(5).join(' ');
                    clockElement.textContent = clockText;
                }
            }
            
            function showModal() {
                confirmationModal.classList.remove('hidden');
                setTimeout(() => {
                     confirmationModal.classList.remove('opacity-0');
                     modalContent.classList.remove('scale-95');
                }, 10);
            }
            
            function hideModal() {
                confirmationModal.classList.add('opacity-0');
                modalContent.classList.add('scale-95');
                setTimeout(() => {
                    confirmationModal.classList.add('hidden');
                }, 200);
            }

            /**
             * Handles clicking on a trial item in the list
             * @param {Event} e - The click event
             */
            function handleTrialClick(e) {
                if (isTiming) return; // Don't allow changing selection while timing
                
                const clickedItem = e.currentTarget; // Get the <li> that was clicked

                // Remove 'selected' from previously selected item
                if (selectedTrialElement) {
                    selectedTrialElement.classList.remove('selected');
                }
                
                // Add 'selected' to the new item
                clickedItem.classList.add('selected');
                selectedTrialElement = clickedItem;
                
                updateButtonStates();
            }

            /**
             * Creates a single trial list item
             * @param {string} name - The text content for the trial
             * @returns {HTMLLIElement}
             */
            function createTrialItem(name) {
                const li = document.createElement('li');
                li.className = 'trial-item p-3 hover:bg-gray-100 cursor-pointer border-b last:border-b-0';
                li.textContent = name;
                li.draggable = true; // Required for Sortable.js
                li.addEventListener('click', handleTrialClick);
                return li;
            }

            /**
             * Populates the trial list from the trialNames Array
             */
            function populateTrialList(selectName = null) {
                trialList.innerHTML = ''; // Clear existing options
                
                trialNames.forEach(name => {
                    const li = createTrialItem(name);
                    trialList.appendChild(li);
                    
                    if (name === selectName) {
                        li.click(); // Select this item
                    }
                });

                // Select first item if nothing else is selected
                if (!selectedTrialElement && trialList.firstChild) {
                    trialList.firstChild.click();
                }
                
                updateButtonStates();
            }

            /**
             * Updates the trialNames array to match the DOM order after drag/drop
             */
            function updateTrialNamesFromDOM() {
                trialNames = [];
                const items = trialList.querySelectorAll('li.trial-item');
                items.forEach(item => trialNames.push(item.textContent));
                // Note: The 'selected' item remains the same, just its position changes.
            }

all-items {
            transition: background-color 0.1s ease-in-out;
        }
        
        /* Style for the selected trial */
        .trial-item.selected {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: 500;
        }
        
        /* Style for the item being dragged (Sortable.js class) */
        .sortable-ghost {
            background-color: #dbeafe; /* blue-100 */
            opacity: 0.7;
            border-radius: 0.5rem; /* rounded-lg */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-3xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
            Time Sync App
        </h1>

        <!-- Real-time Clock -->
        <p id="realTimeClock" class="text-xl font-medium text-center text-gray-600 mb-6 font-mono">
            <!-- Clock will be populated by JS -->
        </p>

        <!-- Trial Selection and Custom Tag Input -->
        <div class="mb-6">
            <label for="trialList" class="block text-sm font-medium text-gray-700 mb-2">
                1. Select Trial (Click to select, Drag to re-order)
            </label>
            <!-- Sortable List (replaces dropdown) -->
            <ul id="trialList" class="w-full max-h-48 overflow-y-auto border border-gray-300 rounded-lg bg-white shadow-sm disabled:opacity-50 disabled:bg-gray-50">
                <!-- Trial items will be populated by JS -->
            </ul>
            
            <!-- Notes Input -->
            <div class="mt-3">
                <label for="notesInput" class="block text-sm font-medium text-gray-700 mb-2">
                    2. Add Notes (Optional)
                </label>
                <textarea id="notesInput" rows="3" placeholder="Enter notes for this trial..." class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50 disabled:bg-gray-50"></textarea>
            </div>
            
            <!-- Add/Remove Tag -->
            <div class="flex flex-col sm:flex-row gap-3 mt-4">
                <input type="text" id="customTagInput" placeholder="Type new tag name..." class="flex-grow block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50 disabled:bg-gray-50">
            </div>
            <div class="flex gap-3 mt-3">
                <button id="addTagButton" class="w-full px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 disabled:opacity-50">
                    Add Tag
                </button>
                 <button id="removeTagButton" class="w-full px-5 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Remove Selected Tag
                </button>
            </div>
        </div>

        <!-- Start / Stop Buttons -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
            <button id="startButton" class="w-full py-4 px-6 bg-green-500 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                START
            </button>
            <button id="stopButton" class="w-full py-4 px-6 bg-red-500 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                STOP
            </button>
        </div>

        <!-- Log Area -->
        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
            <h2 class="text-2xl font-semibold text-gray-700">
                Event Log
            </h2>
            <div class="flex gap-2 flex-wrap">
                <button id="discardLastButton" class="px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded-lg shadow-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Discard Last
                </button>
                <button id="resetLogButton" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Reset Log
                </button>
                <button id="exportButton" class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Export to CSV
                </button>
            </div>
        </div>

        <div class="log-container w-full max-h-80 overflow-y-auto border border-gray-200 rounded-lg bg-gray-50 p-1">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Trial
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Event
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Notes
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Timestamp
                            </th>
                        </tr>
                    </thead>
                    <tbody id="logBody" class="bg-white divide-y divide-gray-200">
                        <!-- Log entries will be populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
        <p id="emptyLogMessage" class="text-center text-gray-500 pt-4">Log is empty.</p>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div id="modalContent" class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 transform scale-95">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Are you sure?</h3>
            <p class="text-gray-600 mb-6">This action will permanently delete all log entries. This cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button id="cancelResetButton" class="px-5 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200">
                    Cancel
                </button>
                <button id="confirmResetButton" class="px-5 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200">
                    Confirm Reset
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE ---
            let logData = [];
            let isTiming = false;
            let currentTrialName = '';
            let selectedTrialElement = null; // Holds the currently selected <li>
            // Use an Array to maintain order
            let trialNames = [
                'OFF_30s_T1',
                'Trial1',
                'OFF_30s_T2',
                'Trial2',
                'OFF_30s_T3',
                'Trial3',
                'OFF_3D'trial-item',
                'OFF_30s_T1',
                'Trial1',
                'OFF_30s_T2',
                'Trial2',
                'OFF_30s_T3',
                'Trial3',
                'OFF_30s_T4',
                'Trial4'
            ];

            // --- DOM ELEMENTS ---
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const exportButton = document.getElementById('exportButton');
            const trialList = document.getElementById('trialList'); // New <ul>
            const notesInput = document.getElementById('notesInput');
            const customTagInput = document.getElementById('customTagInput');
            const addTagButton = document.getElementById('addTagButton');
            const removeTagButton = document.getElementById('removeTagButton');
            // 'Move Up' and 'Move Down' buttons are removed
            const discardLastButton = document.getElementById('discardLastButton');
            const resetLogButton = document.getElementById('resetLogButton');
            const logBody = document.getElementById('logBody');
            const emptyLogMessage = document.getElementById('emptyLogMessage');
            const clockElement = document.getElementById('realTimeClock');
            
            // Modal Elements
            const confirmationModal = document.getElementById('confirmationModal');
            const modalContent = document.getElementById('modalContent');
            const cancelResetButton = document.getElementById('cancelResetButton');
            const confirmResetButton = document.getElementById('confirmResetButton');

            // --- FUNCTIONS ---
            
            /**
             * Updates the real-time clock
             */
            function updateClock() {
                if (clockElement) {
                    const fullString = new Date().toString();
                    const parts = fullString.split(' ');
                    // parts[4] is the time (e.g., 22:01:21)
                    // parts.slice(5) are the timezone parts
                    const clockText = parts[4] + ' ' + parts.slice(5).join(' ');
                    clockElement.textContent = clockText;
                }
            }
            
            function showModal() {
                confirmationModal.classList.remove('hidden');
                setTimeout(() => {
                     confirmationModal.classList.remove('opacity-0');
                     modalContent.classList.remove('scale-95');
                }, 10);
            }
            
            function hideModal() {
                confirmationModal.classList.add('opacity-0');
                modalContent.classList.add('scale-95');
                setTimeout(() => {
                    confirmationModal.classList.add('hidden');
                }, 200);
            }

            /**
             * Handles clicking on a trial item in the list
             * @param {Event} e - The click event
             */
            function handleTrialClick(e) {
                if (isTiming) return; // Don't allow changing selection while timing
                
                const clickedItem = e.currentTarget; // Get the <li> that was clicked

                // Remove 'selected' from previously selected item
                if (selectedTrialElement) {
                    selectedTrialElement.classList.remove('selected');
                }
                
                // Add 'selected' to the new item
                clickedItem.classList.add('selected');
                selectedTrialElement = clickedItem;
                
                updateButtonStates();
            }

            /**
             * Creates a single trial list item
             * @param {string} name - The text content for the trial
             * @returns {HTMLLIElement}
             */
            function createTrialItem(name) {
                const li = document.createElement('li');
                li.className = 'trial-item p-3 hover:bg-gray-100 cursor-pointer border-b last:border-b-0';
                li.textContent = name;
                li.draggable = true; // Required for Sortable.js
                li.addEventListener('click', handleTrialClick);
                return li;
            }

            /**
             * Populates the trial list from the trialNames Array
             */
            function populateTrialList(selectName = null) {
                trialList.innerHTML = ''; // Clear existing options
                
                trialNames.forEach(name => {
                    const li = createTrialItem(name);
                    trialList.appendChild(li);
                    
                    if (name === selectName) {
                        li.click(); // Select this item
                    }
                });

                // Select first item if nothing else is selected
                if (!selectedTrialElement && trialList.firstChild) {
                    trialList.firstChild.click();
                }
                
                updateButtonStates();
            }

            /**
             * Updates the trialNames array to match the DOM order after drag/drop
             */
            function updateTrialNamesFromDOM() {
                trialNames = [];
                const items = trialList.querySelectorAll('li.trial-item');
                items.forEach(item => trialNames.push(item.textContent));
                // Note: The 'selected' item remains the same, just its position changes.
            }

            function renderLog() {
                logBody.innerHTML = ''; 
                
                if (logData.length === 0) {
                    emptyLogMessage.classList.remove('hidden');
                    exportButton.disabled = true;
                } else {
                    emptyLogMessage.classList.add('hidden');
                    exportButton.disabled = false;
                }

                logData.forEach(entry => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${entry.trial}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${entry.event === 'Start' ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold'}">${entry.event}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${entry.notes || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${entry.timestamp}</td>
                    `;
                    logBody.appendChild(row);
                });
                
                updateButtonStates();
            }

            function handleAddTag() {
                const newTag = customTagInput.value.trim();
                if (newTag && !trialNames.includes(newTag)) {
                    trialNames.push(newTag);  // Add to the Array
                    
                    // Add directly to DOM instead of full re-render
                    const li = createTrialItem(newTag);
                    trialList.appendChild(li);
                    li.click(); // Select the newly added tag
                    
                    customTagInput.value = '';
                } else if (trialNames.includes(newTag)) {
                    // If tag already exists, just select it
                    const allItems = Array.from(trialList.querySelectorAll('li.trial-item'));
                    const itemToSelect = allItems.find(item => item.textContent === newTag);
                    if (itemToSelect) itemToSelect.click();
                    customTagInput.value = '';
                }
            }
            
            function handleRemoveTag() {
                if (!selectedTrialElement) return; // Nothing selected
                
                const nameToRemove = selectedTrialElement.textContent;
                trialNames = trialNames.filter(name => name !== nameToRemove);
                
                const itemToRemove = selectedTrialElement;
                
                // Select next item or previous item before removing
                const allItems = Array.from(trialList.querySelectorAll('li.trial-item'));
                const currentIndex = allItems.indexOf(itemToRemove);
                
                if (currentIndex < allItems.length - 1) { // Not the last item
                    allItems[currentIndex + 1].click();
                } else if (currentIndex > 0) { // Is the last item, select previous
                    allItems[currentIndex - 1].click();
                } else { // It was the only item
                    selectedTrialElement = null;
                }

                itemToRemove.remove();
                updateButtonStates();
            }

            function handleStart() {
                if (!selectedTrialElement) {
                    // You could show a custom modal error here
                    console.error("No trial selected");
                    return;
                }
                
                isTiming = true;
                currentTrialName = selectedTrialElement.textContent;
                const notes = notesInput.value.trim();
                const timestamp = new Date().toString();

                logData.push({
                    trial: currentTrialName,
                    event: 'Start',
                    notes: notes,
                    timestamp: timestamp
                });
                
                notesInput.value = '';
                renderLog();
                updateButtonStates();
            }

            function handleStop() {
                isTiming = false;
                const timestamp = new Date().toString();

                logData.push({
                    trial: currentTrialName,
                    event: 'Stop',
                    notes: '',
                    timestamp: timestamp
                });

                renderLog();
                updateButtonStates();
                
                // --- Auto-advance to next trial ---
                if (!selectedTrialElement) return;
                
                const allItems = Array.from(trialList.querySelectorAll('li.trial-item'));
                const currentIndex = allItems.indexOf(selectedTrialElement);
                
                if (currentIndex < allItems.length - 1) {
                    allItems[currentIndex + 1].click(); // Click the next item in the list
                }
            }
            
            function handleDiscardLast() {
                if (logData.length > 0) {
                    logData.pop();
                }
                
                const lastEntry = logData.length > 0 ? logData[logData.length - 1] : null;
                
                if (!lastEntry) {
                    isTiming = false;
                    currentTrialName = '';
                } else {
                    isTiming = lastEntry.event === 'Start';
                    if (isTiming) {
                        currentTrialName = lastEntry.trial;
                        notesInput.value = lastEntry.notes || '';
                        
                        // Re-select the trial associated with the START
                        const allItems = Array.from(trialList.querySelectorAll('li.trial-item'));
                        const itemToSelect = allItems.find(item => item.textContent === currentTrialName);
                        if (itemToSelect) itemToSelect.click();
                    }
                }
                
                renderLog();
                updateButtonStates();
            }

            function executeReset() {
                logData = [];
                isTiming = false;
                currentTrialName = '';
                notesInput.value = '';
                renderLog();
                updateButtonStates();
                hideModal();
            }

            function updateButtonStates() {
                // If timing, disable START, list, and all tag/note management
                startButton.disabled = isTiming;
                
                // Disable list interaction
                trialList.classList.toggle('opacity-50', isTiming);
                trialList.classList.toggle('pointer-events-none', isTiming);
                
                notesInput.disabled = isTiming;
                customTagInput.disabled = isTiming;
                addTagButton.disabled = isTiming;
                
                // If NOT timing, disable STOP
                stopButton.disabled = !isTiming;

                // Log-dependent buttons
                discardLastButton.disabled = logData.length === 0;
                resetLogButton.disabled = logData.length === 0;
                
                // Tag management buttons (when not timing)
                const hasSelection = selectedTrialElement !== null;
                removeTagButton.disabled = !hasSelection || isTiming;
            }

            function handleExport() {
                if (logData.length === 0) return;

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Trial,Event,Notes,Timestamp\n"; 

                logData.forEach(entry => {
                    const notes = `"${(entry.notes || '').replace(/"/g, '""')}"`;
                    const timestamp = `"${entry.timestamp}"`;
                    const row = [entry.trial, entry.event, notes, timestamp].join(",");
                    csvContent += row + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "time_sync_log.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // --- INITIALIZATION ---
            updateClock(); // Initial clock update
            setInterval(updateClock, 1000); // Update clock every second

            populateTrialList();
            updateButtonStates();
            renderLog();

            // Initialize Sortable.js
            new Sortable(trialList, {
                animation: 150,
                ghostClass: 'sortable-ghost', // Class for the ghost element
                onEnd: updateTrialNamesFromDOM // Callback when drag ends
            });

            // --- EVENT LISTENERS ---
            startButton.addEventListener('click', handleStart);
            stopButton.addEventListener('click', handleStop);
            exportButton.addEventListener('click', handleExport);
            
            // Tag Management
            addTagButton.addEventListener('click', handleAddTag);
            removeTagButton.addEventListener('click', handleRemoveTag);
            customTagInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleAddTag();
                }
            });
            
            // Log Management
            discardLastButton.addEventListener('click', handleDiscardLast);
            resetLogButton.addEventListener('click', showModal);
            
            // Modal Listeners
            cancelResetButton.addEventListener('click', hideModal);
            confirmResetButton.addEventListener('click', executeReset);

        });
    </script>

</body>
</html>

